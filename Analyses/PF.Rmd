---
title: "Phloem Feeding Insects Inhibit Caterpillar Parasitism"
author: "Riley M. Anderson"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
graphics: yes
output:
  github_document:
    toc: yes
  html_document:
    keep_md: yes
    theme: readable
  html_notebook:
    code_folding: hide
    theme: readable
editor_options:
  chunk_output_type: console
---

```{r setup, include = F}
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
# @@@@@ Knitr Options
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

# Set root directory to the project directory
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())


# Set default knitr options: 
# Suppress warnings and messages, cache chunks, 
#  set default figure size to 6x8 at 300 dpi, and save a png and pdf
knitr::opts_chunk$set(warning = F, message = F, collapse = T, cache = T,
    fig.height = 6, fig.width = 8, dpi = 300, # 6x8" @ 300dpi:1800x2400=4.3MP
    dev = c('png', 'pdf'), dev.args = list(pdf = list(onefile = F)))

```





```{r Main_Code, include = F, cache = F}

# Load Packages
library(tidyverse) 
library(cowplot) 
library(lme4)
library(knitr)
library(forcats)
library(glmmTMB)
library(vegan)
library(tidymodels)

# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
# @@@@@ Data Preparation
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

## Import datasets:

# experiment data:
dat1 <- read.csv("data/data.19.20.21.22.csv")

# recovery rate data (caterpillars stocked):
rec.data <- read.csv("data/recovery.csv")

# volatile data:
chem <- read.csv("data/Mike_Trees_herbivores2.csv")

####################################################
#                    Functions                     #
####################################################


# Function to scale the range of values so that they are always positive or always negative, respectively:

range01 <- function(x){
  (x-min(x, na.rm = TRUE))/(max(x, na.rm = TRUE)-min(x, na.rm = TRUE))
  }


# Function to check for overdispersion in poisson and binomial models:

overdispersion_test <- function(model, type = "pearson"){
    
    # Get the pearson residuals
    residuals <- resid(model, type = type)
    
    # Get the residual degrees of freedom of the model
    df <- df.residual(model)
    
    # Sum of residual deviance
    dev <- sum(residuals ^ 2)
    
    # Overdispersion = sum of squared residuals / residual degrees of freedom
    ratio <- round(dev / df, 3)
    
    # P-value 
    pvalue <- round(pchisq(dev, df, lower.tail = FALSE), 3)
    
    # Get the formula
    f = paste(as.character(formula(model))[2:3], collapse = " ~ ")
    
    # Get the model name
    name <- deparse(substitute(model))
    cat("Overdispersion ratio for model:", name, "\nformula:", f, 
        "\n\nAcceptable range: 1 - 1.4\nOverdispersion ratio:",
        ratio, " df:", df, " p =", pvalue, "\n", 
        ifelse(pvalue < 0.05, "Data are overdispersed\n", 
        "Data are not overdispersed\n"))
    
    # Return all the parameters
    return(c(ratio = ratio, deviance = dev, df = df, pvalue = pvalue))
    
}

# Function to generate ellipses dataset:

veganCovEllipse<-function (cov, center = c(0, 0), scale = 1, npoints = 100) 
{
  theta <- (0:npoints) * 2 * pi/npoints
  Circle <- cbind(cos(theta), sin(theta))
  t(center + scale * t(Circle %*% chol(cov)))
}

```


# Overview


```{r Data_Wrangling, echo = F, comment = ""}

# experimental data:
dat1 <- dat1 %>% 
  mutate(across(c(branchID : para), as.factor),
         para = as.numeric(para) - 1,
         site = fct_recode(site, "PR" = "MS"))


# recovery rate data:
rec.data <- rec.data %>% 
  mutate(across(c(year:ant_treatment), as.factor),
         not_para = recovered - parasitized,
         prop_para = parasitized/recovered,
         prop_recovered = recovered/stocked)

# volatile data:
chem <- chem %>% 
  mutate(treatment.1 = ifelse(treatment.1 == "minus",
                              "removed", "replaced"))



```

# Recovery Rates:

```{r recovery, echo = F}

rec.mod <- glm(prop_recovered ~ pf_treatment * ant_treatment +
                 site + year,
               family = quasibinomial(), # for overdispersion
               data = filter(rec.data, prop_recovered <= 1),
               # remove 1 record where recovery > stocked
               weights = stocked,
               contrasts = list(year = "contr.sum",
                                site = "contr.sum"))



kable(tidy(rec.mod), format = "markdown", digits = 3)



```

# Ants and Phloem-feeders:

## GLMM approach
```{r pf_ant_glmm, echo = F}

# mod1.interaction <- glmmTMB(para ~ pf_treatment * ant_treatment +
#                      year + (1 | site) + (1 | cat_species),
#                    family = binomial(),
#                    contrasts = list(year = "contr.sum"),
#                 data = filter(dat1, year == "2019" | year == "2022"))
                # doesn't converge with data = dat1

mod1.interaction <- glmmTMB(para ~ year + pf_treatment * ant_treatment +
                       site + (1 | cat_species), 
                     family = binomial(),
                     #contrasts = list(year = "contr.helmert"),
                     data = dat1)

# summary(mod1.interaction)
# b1 <- lme4::bootMer(mod1.interaction, FUN=function(x) fixef(x)$cond, nsim=100, 
#                     ncpus=8)
# apply(b1$t, 2, quantile, c(0.025, 0.975)) ## demonstrates the CIs don't cross 0.

# mod1.interaction_robust <- brglm::brglm(para ~ year + pf_treatment * ant_treatment,
#                      family = binomial(),
#                      contrasts = list(year = "contr.helmert"),
#                      data = dat1)
# summary(mod1.interaction_robust) ## robust method - confirms the result, 
# but without random effects

# Likelihood ratio tests:
mod2.additive.only <- update(mod1.interaction, ~ . -pf_treatment : ant_treatment)

mod3.pf.only <- update(mod2.additive.only, ~ . -ant_treatment)

mod4.no.pf <- update(mod3.pf.only, ~ . -pf_treatment)

mod5.no.year <- update(mod4.no.pf, ~ . -year)

mod6.no.site <- update(mod5.no.year, ~ . -site)

results <- as_tibble(anova(mod1.interaction,
                           mod2.additive.only,
                           mod3.pf.only,
                           mod4.no.pf,
                           mod5.no.year,
                           mod6.no.site,
                           test = "LRT"),
                     rownames = "LRT_models")

lrt.names <- c("Null model",
               "Site",
               "Year + Site",
               "Phloem-feeders",
               "Phloem-feeders + Ants",
               "Phloem-feeders x Ants")

results <- results %>% 
  mutate(LRT_models = lrt.names)

kable(results, format = "markdown", digits = 3)



```

# Figure 2:

## proportion recovered-all years
```{r Figure_2_prop, echo = F}

n_cats_treatment <- dat1 %>% 
  group_by(pf_treatment, ant_treatment) %>% 
  tally() %>% 
  rename(ncats = n)

fig2data <- dat1 %>% 
  mutate(para = factor(para)) %>% 
  group_by(pf_treatment, ant_treatment, para) %>% 
  tally() %>% 
  left_join(., n_cats_treatment,
            by = c("pf_treatment", "ant_treatment")) %>% 
  mutate(ant_treatment = case_when(
    ant_treatment == "access" ~ "Ant access",
    TRUE ~ "Ant exclusion"
  ))

fig2labels <- fig2data %>% 
  filter(para == "1") %>% 
  mutate(prop = round(100 * (n / ncats), 1),
    label = paste0(prop, "%", sep = ""))

fig2_prop <- fig2data %>%
  ggplot(aes(x = pf_treatment, y = n/ncats, fill = para)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ ant_treatment) +
  geom_text(data = fig2labels,
            label = fig2labels$label,
            nudge_y = -0.08) +
  labs(x = "Phloem-feeder treatment",
       y = "Prop. of caterpillars\nrecovered",
       fill = "") +
  scale_fill_manual(values = c("#56B4E9", "#D55E00"),
                    labels = c("unparasitized", "parasitized")) +
  theme_cowplot() +
  theme(legend.title.align = 0.5,
        strip.background = element_blank()) 

fig2_prop

```



## counts all years

```{r Figure_2_allyears, echo = F}

dat1 %>% 
  mutate(ant_treatment = case_when(
    ant_treatment == "access" ~ "Ant access",
    TRUE ~ "Ant exclusion"
  ),
  para = factor(para)) %>% 
  group_by(pf_treatment, ant_treatment, para) %>% 
  tally() %>% 
  ggplot(aes(x = pf_treatment, y = n, fill = para)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ ant_treatment) +
  scale_fill_manual(values = c("#56B4E9", "#D55E00"),
                    labels = c("unparasitized",
                               "parasitized")) +
  theme_cowplot(font_size = 14) +
  theme(legend.title.align = 0.5,
        strip.background = element_blank(),
        legend) +
  labs(x = "Phloem feeder treatment",
       y = "Caterpillar count",
       fill = "") +
  geom_text(data = fig2labels,
            label = fig2labels$label,
            nudge_y = -1.5)
```


## all years no ant effects

```{r Figure_2_no_ants, echo = F}

dat1 %>% 
  mutate(para = factor(para)) %>% 
  group_by(pf_treatment, para) %>% 
  tally() %>% 
  ggplot(aes(x = pf_treatment, y = n, fill = para)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("#56B4E9", "#D55E00"),
                    labels = c("unparasitized",
                               "parasitized")) +
  theme_cowplot() +
  labs(x = "Phloem feeder treatment",
       y = "Caterpillar count",
       fill = "")


```



```{r new_pf_figure2, echo = F, fig.width = 10}


Atest <- dat1 %>% 
  mutate(para = factor(para)) %>% 
  ggplot(aes(x = year, y = para,
             color = pf_treatment, shape = ant_treatment)) +
  geom_jitter(height = .4, width = .22, size = 3) +
  scale_color_manual(values = c("#D57E00", "#56B4E9")) +
  scale_y_discrete(labels = c("not parasitized", "parasitized")) +
  labs(x = "Year", y = "",
       color = "Phloem-feeders",
       shape = "Ants") +
  geom_hline(yintercept = 1.5, linetype = "dashed") +
  theme_cowplot(font_size = 18) +
  coord_flip()

A <- dat1 %>% 
  mutate(para = factor(para)) %>% 
  ggplot(aes(x = year, y = para,
             color = pf_treatment, shape = ant_treatment)) +
  geom_jitter(height = .4, width = .15, size = 3) +
  scale_color_manual(values = c("#D57E00", "#56B4E9")) +
  scale_y_discrete(labels = c("", ""),
                   expand = c(.15, 0.3)) +
  labs(x = "Year", y = "",
       color = "Phloem-feeders",
       shape = "Ants") +
  geom_hline(yintercept = 1.5, linetype = "dashed") +
  theme_cowplot(font_size = 18) +
  coord_flip() +
  theme(legend.position = "none")

  
B <- dat1 %>% 
  mutate(para = factor(para)) %>% 
  ggplot(aes(x = site, y = para,
             color = pf_treatment, shape = ant_treatment)) +
  geom_jitter(height = .4, width = .15, size = 3) +
  scale_color_manual(values = c("#D57E00", "#56B4E9")) +
  scale_y_discrete(labels = c("not parasitized", "parasitized"),
                   expand = c(0.15, .3)) +
  scale_x_discrete(labels = c(" CK ", " CP ", " GH ",  " PR ")) +
  labs(x = "Site", y = "",
       color = "Phloem-feeders",
       shape = "Ants") +
  geom_hline(yintercept = 1.5, linetype = "dashed") +
  theme_cowplot(font_size = 18) +
  coord_flip() +
  theme(legend.position = "none")

grobs <- ggplotGrob(Atest)$grobs

legend <- grobs[[which(sapply(grobs, function(x) x$name) == "guide-box")]]




p1 <- cowplot::plot_grid(A, NULL, B, labels = c("A", "", "B"),
          ncol = 1, nrow = 3, rel_heights = c(1, -0.2, 1),
          greedy = T)

cowplot::plot_grid(p1, legend, ncol = 2,
          rel_widths = c(.45, 0.1),
          rel_heights = c(4, 4))

```

**Figure 2.** Caterpillar parasitism patterns across years (A) and sites (B) by experimental phloem-feeder manipulation (removal in orange, replacement in blue) and experimental ant treatment (ant access in circles, ant exclusion in triangles). Each point is a single caterpillar. Points are jittered for clarity. For detailed description of sites, tree replicates, and caterpillar sample sizes, see table S1.


```{r figure2_Robi, echo = F}
# library(ggdist)
# 
# nsim <- 100
# preddat <-  expand.grid(ant_treatment = c("access", "excluded"),
#                         pf_treatment = c("removed", "replaced"), 
#                         year = 2019)
# cis <- do.call("rbind", sapply(1:nsim, function(i, mod, newdat){
#   new_y <- simulate(mod)[,1]
#   mod_new <- refit(mod, new_y)
#   predict(mod_new, newdata = newdat, re.form=~0)
# }, mod = mod1.interaction, newdat = preddat, simplify=FALSE))
# 
# pred_probs <- data.frame(
#   preddat,
#   prob = plogis(predict(mod1.interaction, newdata = preddat, re.form=~0)), 
#           t(plogis(apply(cis, 2, quantile, c(0.025, 0.975)))))
# names(pred_probs)[5:6] <- c("lower", "upper")
# 
# pred_probs$xloc = as.numeric(pred_probs$pf_treatment)
# 
# dat1 |> mutate(xloc = as.numeric(pf_treatment)  +
#                   (as.numeric(year) - 2.5)*0.05 + (as.numeric(site) - 3)*0.2) |> #runif(nrow(dat1), -0.1, 0.1))
#   ggplot() +
#   facet_wrap(~ant_treatment) +
#   geom_swarm(aes(x = xloc, y = para, side = as.factor(para), fill = year:site), 
#              dotsize = 1.5, colour = NA) +
#   geom_pointrange(data = pred_probs, aes(x = xloc, y = prob, ymin = lower, ymax = upper)) +
#   scale_side_mirrored(guide = "none") + 
#   scale_x_continuous(breaks=c(1, 2), labels =c("removed", "replaced")) +
#   scale_y_continuous(breaks = c(0, 1), 
#                      labels = c("Unparatisized", "Parasitized")) +
#   scale_shape_discrete() +
#   coord_cartesian(ylim = c(0, 1)) +
#   labs(x = "Treatment", y = NULL) +
#   theme_classic() + 
#   theme(strip.background = element_blank())
#         



```

# Supplemental table
```{r supp_table, echo = F}

rec.year <- rec.data %>% 
  select(-not_para, -prop_para, -prop_recovered) %>% 
  mutate(pfant = factor(paste(pf_treatment, ant_treatment, sep = "_"))) %>% 
  select(-pf_treatment, -ant_treatment, -site) %>% 
  group_by(year, pfant) %>%
  summarise(stocked = sum(stocked),
            recovered = sum(recovered),
            parasitized = sum(parasitized)) %>% 
  pivot_wider(names_from = pfant,
              values_from = c(stocked, recovered, parasitized))



rec.site <- rec.data %>% 
  select(-not_para, -prop_para, -prop_recovered) %>% 
  mutate(pfant = factor(paste(pf_treatment, ant_treatment, sep = "_"))) %>% 
  select(-pf_treatment, -ant_treatment, -year) %>% 
  group_by(site, pfant) %>%
  summarise(stocked = sum(stocked),
            recovered = sum(recovered),
            parasitized = sum(parasitized)) %>% 
  pivot_wider(names_from = pfant,
              values_from = c(stocked, recovered, parasitized))

rec.year.site <- bind_rows(rec.year, rec.site)

write.csv(rec.year.site,
          file = "data/recover.year.site.csv",
          row.names = F)

```


```{r pf_glmm_Robi, echo = F}

 
## don't include ant_treatment as a random effect. With 2 levels it's 
## meaningless. Just leave it out or include as a fixed effect (perhaps 
## make it sum-to-zero contrasts so other coefficients are expressed at 
## their sum
## Could also make that argument for year (note that year has a 
## vanishingly small effect, which is throwing the errors in glmer

# pf.mod <- glmmTMB(para ~ year + pf_treatment + 
#                     (1 | site) + (1 | cat_species),
#                   data = dat1, family = binomial(),
#                   contrasts = list(year = "contr.sum"))
# 
# 
# summary(pf.mod) # doesn't work
# 
# 
# ## use likelihood ratio test
# pf.mod0 <- update(pf.mod, ~.-pf_treatment)
# anova(pf.mod, pf.mod0) ## very strong reduction of deviance with addition of 
# ## pf treatment
# sims <- simulate(pf.mod0, 10)
# ## bootstrap
# nsim <- 99
# dev_pf <- deviance(pf.mod0) - deviance(pf.mod)
# test <- sapply(1:nsim, function(i, mod0, mod1){
#   new_y <- simulate(mod0)[,1]
#   mod0_new <- refit(mod0, new_y)
#   mod1_new <- refit(mod1, new_y)
#   dev <- deviance(mod0_new) - deviance(mod1_new)
#   return(dev)
# }, mod0 = pf.mod0, mod1 = pf.mod)
# 
# sum(test > deviance(pf.mod0) - deviance(pf.mod))/(nsim + 1)
# hist(test, xlim = c(0, max(dev_pf, test)*1.5)); abline(v = dev_pf)
# 
# 
# 
# anova(pf.mod, pf.mod0, test = "LRT")
```

# Volatiles

```{r volatile_prep, echo = F, include = FALSE}

# NMDS
nmds <- metaMDS(chem[, 5:37], distance = "bray", k = 2)

# Add the "treatment" variable to the NMDS result
nmds_data <- data.frame(nmds$points, treatment = chem$treatment, 
                        exclusion = chem$treatment.1, 
                        taxon = chem$ploem.feeder,
                        sites = 1:16,
                        row.names = "sites")

# Calculate centroid for each treatment
centroids <- nmds_data %>% 
  group_by(exclusion, taxon, treatment) %>%  
  summarize(MDS1 = mean(MDS1), MDS2 = mean(MDS2))

# ellipses
nmds_data <- nmds_data %>% 
  unite(treatment, c("exclusion", "taxon"))

nmdsmeta <- data.frame(
  MDS1 = nmds$points[,1],
  MDS2 = nmds$points[,2],
  group = nmds_data$treatment
)

nmdsmeta <- nmdsmeta %>% 
  mutate(group = factor(group))


plot(nmds)
ord <- ordiellipse(nmds,
                   nmds_data$treatment,
                   display = "sites",
                   kind = "se", conf = 0.95, label = T)

df_ell <- data.frame()

for(g in levels(nmdsmeta$group)){
  df_ell <- rbind(df_ell,
                  cbind(
                    as.data.frame(with(
                      nmdsmeta[nmdsmeta$group==g,],
                      veganCovEllipse(ord[[g]]$cov,
                                      ord[[g]]$center,
                                      ord[[g]]$scale)))
                                ,group=g))
}

df_ell <- df_ell %>% 
  mutate(exclusion = factor(if_else(grepl("replaced", group),
                             "replaced", "removed")),
         taxon = factor(if_else(grepl("membracid", group),
                         "membracid", "coccid")))

nmds_data <- nmds_data %>% 
  separate_wider_delim(treatment, delim = "_",
                       names = c("exclusion", "taxon"))

cent.labels <- centroids %>% 
  ungroup() %>% 
  mutate(letter = c("a", "a", "ab", "b"))

```

## Volatile Plot
```{r Volatile_plot, echo = F}

ggplot(nmds_data, aes(x = MDS1, y = MDS2, 
                      color = taxon,
                      shape = exclusion)) +
  geom_point(data = nmds_data, size = 1, show.legend = F) +
  geom_point(data = centroids, aes(shape = exclusion),
             size = 4) +
  geom_polygon(data = df_ell,
               aes(x = NMDS1, y = NMDS2,
                   color = taxon, linetype = exclusion), 
               alpha = 0.3, fill = NA,
               show.legend = F) +
  labs(x = "NMDS1", y = "NMDS2",
       shape = "Treatment",
       color = "Taxon") +
  scale_shape_manual(values=c(1, 16)) +
  theme_cowplot(font_size = 16) +
  scale_color_manual(values = c("#D55E00", "#56B4E9")) +
  #guides(shape = guide_legend(override.aes = list(size = 3))) +
  scale_linetype_manual(values = c("dashed", "solid")) +
  geom_text(data = cent.labels,
            label = cent.labels$letter,
            nudge_y = 0.06, nudge_x = -0.06,
            color = 'black')

```




# Session Information

```{r Session_Info, echo = F, comment = ""}

# Add session information to help with reproduceability
sessionInfo()


```


