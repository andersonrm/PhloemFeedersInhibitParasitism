---
title: "Phloem Feeding Insects Inhibit Caterpillar Parasitism"
author: "Riley M. Anderson"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
graphics: yes
output:
  github_document:
    toc: yes
  html_document:
    keep_md: yes
    theme: readable
  html_notebook:
    code_folding: hide
    theme: readable
editor_options:
  chunk_output_type: console
---

```{r setup, include = F}
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
# @@@@@ Knitr Options
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

# Set root directory to the project directory
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())


# Set default knitr options: 
# Suppress warnings and messages, cache chunks, 
#  set default figure size to 6x8 at 300 dpi, and save a png and pdf
knitr::opts_chunk$set(warning = F, message = F, collapse = T, cache = T,
    fig.height = 6, fig.width = 8, dpi = 300, # 6x8" @ 300dpi:1800x2400=4.3MP
    dev = c('png', 'pdf'), dev.args = list(pdf = list(onefile = F)))

```





```{r Main_Code, include = F, cache = F}

# Load Packages
library(tidyverse) 
library(cowplot) 
library(lme4)
library(knitr)
library(forcats)
library(emmeans)
library(glmmTMB)
library(car)

# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
# @@@@@ Data Preparation
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

# Import datasets:

dat1 <- read.csv("data/data.19.20.21.22.csv")

####################################################
#                    Functions                     #
####################################################


# Function to scale the range of values so that they are always positive or always negative, respectively

range01 <- function(x){
  (x-min(x, na.rm = TRUE))/(max(x, na.rm = TRUE)-min(x, na.rm = TRUE))
  }

```


# Overview


```{r Data_Wrangling, echo = F, comment = ""}

dat1 <- dat1 %>% 
  mutate(across(c(branchID : para), as.factor),
         para = as.numeric(para) - 1)

```

# Recovery Rates:

```{r recovery, echo = F}

recovery <- dat1 %>% 
  group_by(year, site, pf_treatment, ant_treatment) %>% 
  tally()


rec.mod <- glm(n ~ pf_treatment + ant_treatment + year + site,
               data = recovery, family = poisson(),
               contrasts = list(site = "contr.sum"))

summary(rec.mod)

```

# Ants and Phloem-feeders:

## GLMM approach
```{r pf_ant_glmm, echo = F}

# mod1.interaction <- glmmTMB(para ~ pf_treatment * ant_treatment +
#                      year + (1 | site) + (1 | cat_species),
#                    family = binomial(),
#                    contrasts = list(year = "contr.sum"),
#                 data = filter(dat1, year == "2019" | year == "2022"))
                # doesn't converge with data = dat1

mod1.interaction <- glmmTMB(para ~ year + pf_treatment * ant_treatment +
                       (1 | site) + (1 | cat_species), 
                     family = binomial(),
                     #contrasts = list(year = "contr.helmert"),
                     data = dat1)

summary(mod1.interaction)
b1 <- lme4::bootMer(mod1.interaction, FUN=function(x) fixef(x)$cond, nsim=100, 
                    ncpus=16)
apply(b1$t, 2, quantile, c(0.025, 0.975)) ## demonstrates the CIs don't cross 0.

# mod1.interaction_robust <- brglm::brglm(para ~ year + pf_treatment * ant_treatment,
#                      family = binomial(),
#                      contrasts = list(year = "contr.helmert"),
#                      data = dat1)
# summary(mod1.interaction_robust)

# Likelihood ratio tests:
mod2.additive.only <- update(mod1.interaction, ~ . -pf_treatment : ant_treatment)

mod3.pf.only <- update(mod2.additive.only, ~ . -ant_treatment)

mod4.no.pf <- update(mod3.pf.only, ~ . -pf_treatment)

results <- as_tibble(anova(mod1.interaction,
                           mod2.additive.only,
                           mod3.pf.only, mod4.no.pf,
                           test = "LRT"),
                     rownames = "LRT_models")

lrt.names <- c("Null model", "Phloem-feeders",
               "Phloem-feeders + Ants",
               "Phloem-feeders x Ants")

results <- results %>% 
  mutate(LRT_models = lrt.names)

results

kable(results, format = "markdown", digits = 3)

```

```{r new_pf_figure2, echo = F, fig.width = 10}
library(ggpattern)

Atest <- dat1 %>% 
  mutate(para = factor(para)) %>% 
  ggplot(aes(x = year, y = para,
             color = pf_treatment, shape = ant_treatment)) +
  geom_jitter(height = .4, width = .22, size = 3) +
  scale_color_manual(values = c("#D57E00", "#56B4E9")) +
  scale_y_discrete(labels = c("not parasitized", "parasitized")) +
  labs(x = "Year", y = "",
       color = "Phloem-feeders",
       shape = "Ants") +
  geom_hline(yintercept = 1.5, linetype = "dashed") +
  theme_cowplot(font_size = 18) +
  coord_flip()

A <- dat1 %>% 
  mutate(para = factor(para)) %>% 
  ggplot(aes(x = year, y = para,
             color = pf_treatment, shape = ant_treatment)) +
  geom_jitter(height = .4, width = .15, size = 3) +
  scale_color_manual(values = c("#D57E00", "#56B4E9")) +
  scale_y_discrete(labels = c("", ""),
                   expand = c(.15, 0.3)) +
  labs(x = "Year", y = "",
       color = "Phloem-feeders",
       shape = "Ants") +
  geom_hline(yintercept = 1.5, linetype = "dashed") +
  theme_cowplot(font_size = 18) +
  coord_flip() +
  theme(legend.position = "none")

  
B <- dat1 %>% 
  mutate(para = factor(para)) %>% 
  ggplot(aes(x = site, y = para,
             color = pf_treatment, shape = ant_treatment)) +
  geom_jitter(height = .4, width = .15, size = 3) +
  scale_color_manual(values = c("#D57E00", "#56B4E9")) +
  scale_y_discrete(labels = c("not parasitized", "parasitized"),
                   expand = c(0.15, .3)) +
  scale_x_discrete(labels = c(" CK ", " CP ", " GH ", " MS ",  " PR ")) +
  labs(x = "Site", y = "",
       color = "Phloem-feeders",
       shape = "Ants") +
  geom_hline(yintercept = 1.5, linetype = "dashed") +
  theme_cowplot(font_size = 18) +
  coord_flip() +
  theme(legend.position = "none")

grobs <- ggplotGrob(Atest)$grobs

legend <- grobs[[which(sapply(grobs, function(x) x$name) == "guide-box")]]

p1 <- plot_grid(A, NULL, B, labels = c("A", "", "B"),
          ncol = 1, nrow = 3, rel_heights = c(1, -0.2, 1),
          greedy = T)

plot_grid(p1, legend, ncol = 2,
          rel_widths = c(.45, 0.1),
          rel_heights = c(4, 4))

```

**Figure 2.** Caterpillar parasitism patterns across years (A) and sites (B) by experimental phloem-feeder manipulation (removal in orange, replacement in blue) and experimental ant treatment (ant access in circles, ant exclusion in triangles). Each point is a single caterpillar. Points are jittered for clarity. For detailed description of sites, tree replicates, and caterpillar sample sizes, see table S1.

# Alternative figure 2
```{r fig2_2, echo = F}

dat2 <- dat1 %>% 
  mutate(yearsite = factor(paste(year, site, sep = " ")),
         pfant = factor(paste(pf_treatment, ant_treatment, sep = " "))) %>% 
  select(yearsite, pfant, para) %>% 
  group_by(yearsite, pfant, para) %>% 
  tally() %>% 
  pivot_wider(names_from = para,
              values_from = n) %>% 
  replace(is.na(.), 0) %>% 
  rename(not_para = "0", para = "1")



dat2 %>%
  ggplot(aes(x = pfant,
             y = para/(para + not_para),
             color = yearsite)) +
  geom_jitter(width = .3, height = 0.01, size = 3) +
  theme_cowplot() +
  labs(x = "", y = "Pr(Parasitism)", color = "Year/Site") +
  scale_x_discrete(labels = c("pf removed\nant access",
                              "pf removed\nant exclusion",
                              "pf replaced\nant access",
                              "pf replaced\nant exclusion"))

```

```{r figure2_Robi}
library(ggdist)

nsim <- 100
preddat <-  expand.grid(ant_treatment = c("access", "excluded"),
                        pf_treatment = c("removed", "replaced"), 
                        year = 2019)
cis <- do.call("rbind", sapply(1:nsim, function(i, mod, newdat){
  new_y <- simulate(mod)[,1]
  mod_new <- refit(mod, new_y)
  predict(mod_new, newdata = newdat, re.form=~0)
}, mod = mod1.interaction, newdat = preddat, simplify=FALSE))

pred_probs <- data.frame(
  preddat,
  prob = plogis(predict(mod1.interaction, newdata = preddat, re.form=~0)), 
          t(plogis(apply(cis, 2, quantile, c(0.025, 0.975)))))
names(pred_probs)[5:6] <- c("lower", "upper")

pred_probs$xloc = as.numeric(pred_probs$pf_treatment)

dat1 |> mutate(xloc = as.numeric(pf_treatment)  +
                  (as.numeric(year) - 2.5)*0.05 + (as.numeric(site) - 3)*0.2) |> #runif(nrow(dat1), -0.1, 0.1))
  ggplot() +
  facet_wrap(~ant_treatment) +
  geom_swarm(aes(x = xloc, y = para, side = as.factor(para), fill = year:site), 
             dotsize = 1.5, colour = NA) +
  geom_pointrange(data = pred_probs, aes(x = xloc, y = prob, ymin = lower, ymax = upper)) +
  scale_side_mirrored(guide = "none") + 
  scale_x_continuous(breaks=c(1, 2), labels =c("removed", "replaced")) +
  scale_y_continuous(breaks = c(0, 1), 
                     labels = c("Unparatisized", "Parasitized")) +
  scale_shape_discrete() +
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = "Treatment", y = NULL) +
  theme_classic() + 
  theme(strip.background = element_blank())
        



```



```{r pf_glmm_Robi, echo = F}

 
## don't include ant_treatment as a random effect. With 2 levels it's 
## meaningless. Just leave it out or include as a fixed effect (perhaps 
## make it sum-to-zero contrasts so other coefficients are expressed at 
## their sum
## Could also make that argument for year (note that year has a 
## vanishingly small effect, which is throwing the errors in glmer

# pf.mod <- glmmTMB(para ~ year + pf_treatment + 
#                     (1 | site) + (1 | cat_species),
#                   data = dat1, family = binomial(),
#                   contrasts = list(year = "contr.sum"))
# 
# 
# summary(pf.mod) # doesn't work
# 
# 
# ## use likelihood ratio test
# pf.mod0 <- update(pf.mod, ~.-pf_treatment)
# anova(pf.mod, pf.mod0) ## very strong reduction of deviance with addition of 
# ## pf treatment
# sims <- simulate(pf.mod0, 10)
# ## bootstrap
# nsim <- 99
# dev_pf <- deviance(pf.mod0) - deviance(pf.mod)
# test <- sapply(1:nsim, function(i, mod0, mod1){
#   new_y <- simulate(mod0)[,1]
#   mod0_new <- refit(mod0, new_y)
#   mod1_new <- refit(mod1, new_y)
#   dev <- deviance(mod0_new) - deviance(mod1_new)
#   return(dev)
# }, mod0 = pf.mod0, mod1 = pf.mod)
# 
# sum(test > deviance(pf.mod0) - deviance(pf.mod))/(nsim + 1)
# hist(test, xlim = c(0, max(dev_pf, test)*1.5)); abline(v = dev_pf)
# 
# 
# 
# anova(pf.mod, pf.mod0, test = "LRT")
```

# Session Information

```{r Session_Info, echo = F, comment = ""}

# Add session information to help with reproduceability
sessionInfo()


```


